// src/ai/flows/get-trending-products.ts
'use server';
/**
 * @fileOverview Generates a list of currently trending products by analyzing Instagram data.
 *
 * - getTrendingProducts - A function that generates a list of trending products.
 * - TrendingProductsOutput - The return type for the getTrendingProducts function.
 */

import {ai} from '@/ai/genkit';
import {z} from 'genkit';
import type { Product } from '@/lib/types';
import fetch from 'node-fetch';

const ProductReviewSchema = z.object({
    platform: z.string().describe("The social media platform (e.g., 'Instagram')."),
    text: z.string().describe("The full text of the social media post."),
    username: z.string().describe("The username of the author of the post."),
    postUrl: z.string().describe("The direct URL to the social media post."),
});

/**
 * Fetches recent top media for a given hashtag from the Instagram Graph API.
 * NOTE: This requires a valid User Access Token with the necessary permissions.
 * The hashtag must be associated with the user's Instagram Business Account.
 * A placeholder is returned if the API token is not configured.
 */
const fetchInstagramData = async (query: string) => {
    const accessToken = process.env.INSTAGRAM_ACCESS_TOKEN;
    if (!accessToken) {
        console.warn(`INSTAGRAM_ACCESS_TOKEN not found for query "${query}". Returning mock data. Please add it to your .env file.`);
        // Return a single mock item so the app doesn't show an empty state.
        return [
            { text: `This is a sample post for ${query}. Configure the API key to see live data. #sample`, username: 'preview_user', postUrl: '#' },
        ].map(p => ({ platform: 'Instagram' as const, ...p }));
    }
    
    const sanitizedQuery = query.replace(/\s+/g, '').toLowerCase();
    const searchUrl = `https://graph.facebook.com/v20.0/ig_hashtag_search?user_id=me&q=${sanitizedQuery}&access_token=${accessToken}`;
    
    try {
        const searchResponse = await fetch(searchUrl);
        const searchData: any = await searchResponse.json();

        if (!searchResponse.ok || !searchData.data || searchData.data.length === 0) {
            console.error(`Failed to find Instagram hashtag for "${query}":`, searchData.error?.message || 'No hashtag found.');
            return [];
        }
        
        const hashtagId = searchData.data[0].id;
        const mediaUrl = `https://graph.facebook.com/v20.0/${hashtagId}/top_media?user_id=me&fields=id,media_type,caption,permalink&limit=5&access_token=${accessToken}`;
        const mediaResponse = await fetch(mediaUrl);
        const mediaData: any = await mediaResponse.json();

        if (!mediaResponse.ok) {
            console.error(`Failed to fetch Instagram media for "${query}":`, mediaData.error?.message);
            return [];
        }

        return mediaData.data.map((post: any) => ({
            platform: 'Instagram' as const,
            text: post.caption || '',
            username: 'instagram_user', // Username is not available from this endpoint
            postUrl: post.permalink || '#',
        }));

    } catch (error) {
        console.error(`Error fetching Instagram data for "${query}":`, error);
        return [];
    }
};


const TrendingProductSchema = z.object({
  id: z.string().describe("A unique product ID, e.g., 'prod-001'"),
  name: z.string().describe('The name of the product.'),
  category: z.string().describe('The category the product belongs to.'),
  forecastedDemand: z.number().describe('The estimated weekly demand for this product.'),
  inventoryStatus: z.enum(['Optimal', 'Overstock', 'Understock']).describe('The current inventory status based on the trend.'),
  lastUpdated: z.string().describe("A human-readable string indicating when this data was generated, e.g., 'Just now' for live data or 'Generated by AI' for fallback data."),
  imageUrl: z.string().describe('A valid placeholder image URL from \'https://placehold.co\' with a size of 64x64.'),
  reviews: z.array(ProductReviewSchema).describe("A list of 2-3 of the most representative social media posts that signal this trend.")
});

const TrendingProductsOutputSchema = z.object({
    products: z.array(TrendingProductSchema)
});

export type TrendingProductsOutput = z.infer<typeof TrendingProductsOutputSchema>;

export async function getTrendingProducts(): Promise<Product[]> {
    const result = await trendingProductsFlow();
    return result.products as Product[];
}

const prompt = ai.definePrompt({
  name: 'getTrendingProductsPrompt',
  model: 'googleai/gemini-1.5-flash-latest',
  output: {schema: TrendingProductsOutputSchema},
  prompt: `You are the AI engine for "TrendSense," a real-time demand forecasting platform for Walmart. Your primary function is to analyze Instagram data to identify viral product trends.

You have been provided with a raw data stream of Instagram posts.

Instagram Data:
{{{socialMediaData}}}

Based on this live data, analyze it to identify up to 10 of the most relevant and impactful product trends for Walmart. A higher mention count with positive sentiment should result in higher demand and an 'Understock' status.

For each of the products you identify, provide the following information:
- A unique product ID (e.g., prod-001, prod-002).
- The specific product name.
- A plausible Walmart category (e.g., Home Goods, Electronics, Apparel, Beauty, Groceries, Toys).
- A forecasted weekly demand as a number, reflecting its viral velocity.
- An inventory status: 'Understock' for new, explosive trends; 'Optimal' for established trends; 'Overstock' for fading trends.
- A lastUpdated string. Use 'Just now' as you are analyzing live data.
- A valid placeholder image URL from 'https://placehold.co' with a size of 64x64.
- A list of 2-3 of the most representative "reviews" (social media posts) from the provided data that justify why this product is trending. Each review must include the platform (always set this to "Instagram"), text, username, and the exact postUrl provided in the source data. Do not alter the postUrl.

Return the list of products in the specified JSON format. You must include reviews for each product.`,
});


const trendingProductsFlow = ai.defineFlow(
  {
    name: 'trendingProductsFlow',
    outputSchema: TrendingProductsOutputSchema,
  },
  async () => {
    const topics = ['air fryer', 'skincare', 'running shoes', 'summer dress', 'gaming keyboard', 'protein powder', 'yoga mat', 'noise cancelling headphones', 'weighted blanket', 'electric scooter'];
    let allPosts: any[] = [];

    for (const topic of topics) {
        const instagramPosts = await fetchInstagramData(topic);
        allPosts = [...allPosts, ...instagramPosts];
    }
    
    const uniquePosts = Array.from(new Map(allPosts.map(p => [p.text, p])).values());

    if (uniquePosts.length === 0) {
        console.log("No social media data fetched. Returning fallback data.");
        return getFallbackProducts();
    }
    
    const socialMediaData = JSON.stringify(uniquePosts, null, 2);
    
    console.log("-----BEGIN SOCIAL MEDIA ANALYSIS-----");
    console.log(`Sending ${uniquePosts.length} unique posts to the AI model.`);
    console.log("-----END SOCIAL MEDIA ANALYSIS-----");

    try {
        const {output} = await prompt({ socialMediaData });
        return output!;
    } catch (error) {
        console.error("AI call failed. This is likely due to API quota limits. Returning fallback data.", error);
        return getFallbackProducts();
    }
  }
);

function getFallbackProducts(): TrendingProductsOutput {
  return {
    products: [
      {
        id: 'fallback-001',
        name: 'Smart Water Bottle',
        category: 'Home Goods',
        forecastedDemand: 1500,
        inventoryStatus: 'Understock',
        lastUpdated: 'Generated by AI',
        imageUrl: 'https://placehold.co/64x64',
        reviews: [
          { platform: 'Instagram', text: 'Just got this smart water bottle and it is a game changer for my hydration goals! #smartbottle #healthyliving', username: 'health_guru_123', postUrl: 'https://www.instagram.com/p/C9_8y7xSj8A/' }
        ],
      },
      {
        id: 'fallback-002',
        name: 'Noise-Cancelling Headphones',
        category: 'Electronics',
        forecastedDemand: 950,
        inventoryStatus: 'Optimal',
        lastUpdated: 'Generated by AI',
        imageUrl: 'https://placehold.co/64x64',
        reviews: [
            { platform: 'Instagram', text: 'Finally got my hands on these headphones. The noise cancellation is unreal!', username: 'musiclover_xyz', postUrl: 'https://www.instagram.com/p/C-iO7o5yCmz/' },
            { platform: 'Instagram', text: 'Perfect for studying or just tuning out the world. Highly recommend. #headphones #focus', username: 'studentlife', postUrl: 'https://www.instagram.com/p/C92R4_kSUSA/' }
        ],
      },
      {
        id: 'fallback-003',
        name: 'Linen Summer Dress',
        category: 'Apparel',
        forecastedDemand: 700,
        inventoryStatus: 'Optimal',
        lastUpdated: 'Generated by AI',
        imageUrl: 'https://placehold.co/64x64',
        reviews: [
            { platform: 'Instagram', text: 'This linen dress is my summer uniform. So breezy and chic! #summerfashion', username: 'style_by_jane', postUrl: 'https://www.instagram.com/p/C9-Xv9JRot_/' }
        ],
      },
      {
        id: 'fallback-004',
        name: 'Vitamin C Serum',
        category: 'Beauty',
        forecastedDemand: 2100,
        inventoryStatus: 'Understock',
        lastUpdated: 'Generated by AI',
        imageUrl: 'https://placehold.co/64x64',
        reviews: [
            { platform: 'Instagram', text: 'My skin has never been brighter since I started using this Vitamin C serum. A must have!', username: 'skincare_addict', postUrl: 'https://www.instagram.com/p/C-B8bYdRLhY/' },
            { platform: 'Instagram', text: 'Look at that glow! All thanks to this amazing serum. #vitaminc #skincareroutine', username: 'glowup_guide', postUrl: 'https://www.instagram.com/p/C9wtfV5ye4K/' }
        ],
      },
      {
        id: 'fallback-005',
        name: 'Portable Blender',
        category: 'Groceries',
        forecastedDemand: 1100,
        inventoryStatus: 'Overstock',
        lastUpdated: 'Generated by AI',
        imageUrl: 'https://placehold.co/64x64',
        reviews: [
          { platform: 'Instagram', text: 'Making smoothies on the go has never been easier with my new portable blender!', username: 'fitlife_frank', postUrl: 'https://www.instagram.com/p/C8_X5b2s_qf/' }
        ],
      },
    ],
  };
}
